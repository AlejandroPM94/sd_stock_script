name: Watch Steam Deck Stock

on:
  schedule:
    # runs every 5 minutes — ajusta según prefieras
    - cron: '*/15 * * * *'
  workflow_dispatch: {}

jobs:
  run-watcher:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Inject cookies (optional)
        run: |
          if [ -n "${{ secrets.COOKIES_JSON_BASE64 }}" ]; then
            echo "Writing cookies.json from secret";
            echo "${{ secrets.COOKIES_JSON_BASE64 }}" | base64 --decode > cookies.json;
          else
            echo "No cookies secret provided; skipping.";
          fi
      - name: Run stock check
        env:
          HEADLESS: 'true'
          INTERVAL_MINUTES: '15'
          ALERT_THROTTLE_MIN: '30'
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FAIL_IF_NOT_LOGGED: ${{ secrets.FAIL_IF_NOT_LOGGED }}
        run: |
          node check_stock.js
      - name: Upload log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: check_stock-log-${{ github.run_id }}
          path: watch_log.txt
          retention-days: 30
